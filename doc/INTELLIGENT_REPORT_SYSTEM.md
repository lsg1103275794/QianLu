# 智能研报系统设计方案

## 1. 系统概述

"智能研报系统"是一个综合性平台，通过集成MCP函数调用功能、大型语言模型(LLM)和智能代理(Agent)，实现数据的智能分析、可视化和研报自动生成。系统参考"问小白"的小白研报功能，为用户提供一站式的数据分析和研报生成服务。

### 1.1 核心价值

- **降低专业门槛**：使普通用户无需专业数据分析背景即可获得高质量的数据分析结果
- **效率提升**：将传统需要数天完成的研报工作缩短至分钟级别
- **智能洞察**：利用大模型能力发现数据中的隐藏模式和价值
- **交互式体验**：用户可以通过自然语言对话方式获取分析结果

## 2. 系统架构

### 2.1 整体架构

```
+-------------------------+       +-------------------------+
|        前端系统         |       |         后端系统        |
|  +------------------+  |       |  +------------------+  |
|  |   Vue.js界面     |  |       |  |  FastAPI服务器   |  |
|  +------------------+  |       |  +------------------+  |
|  |   组件库         |  |       |  |  LLM集成模块     |  |
|  +------------------+  |       |  +------------------+  |
|  |   可视化引擎     |  |<----->|  |  Agent系统       |  |
|  +------------------+  |       |  +------------------+  |
|  |   研报编辑器     |  |       |  |  数据处理管道    |  |
|  +------------------+  |       |  +------------------+  |
|  |   交互式查询     |  |       |  |  MCP函数调用     |  |
|  +------------------+  |       |  +------------------+  |
+-------------------------+       +-------------------------+
                                            |
                                            v
                          +-------------------------+
                          |       外部资源与服务     |
                          |  +------------------+  |
                          |  |  数据库存储      |  |
                          |  +------------------+  |
                          |  |  LLM API服务     |  |
                          |  +------------------+  |
                          |  |  数据源接口      |  |
                          |  +------------------+  |
                          |  |  知识库          |  |
                          |  +------------------+  |
                          +-------------------------+
```

### 2.2 功能模块

- **交互式数据导入模块**：支持多种格式数据文件上传和API数据接入
- **智能分析引擎**：基于LLM的数据理解和分析引擎，可采用先进的检索增强生成(RAG)技术，如GraphRAG，以提升分析的深度和上下文处理能力
- **可视化生成模块**：自动为数据生成最适合的可视化图表
- **研报模板系统**：预设多种行业和场景的研报模板
- **函数调用代理(Agent)**：协调和管理多个工具函数的调用链
- **自然语言交互界面**：实现对话式数据分析体验
- **研报编辑与导出**：支持对生成研报的编辑和多格式导出

## 3. 前端实现

### 3.1 核心组件

```
frontend/
├── src/
│   ├── components/
│   │   ├── report-studio/        # 新增：研报工作室组件集
│   │   │   ├── DataImporter.vue  # 数据导入组件
│   │   │   ├── AnalysisPanel.vue # 分析控制面板
│   │   │   ├── ChartBuilder.vue  # 图表构建器
│   │   │   ├── ReportEditor.vue  # 研报编辑器
│   │   │   ├── TemplateGallery.vue # 模板画廊
│   │   │   └── AIAssistant.vue   # AI助手交互组件
│   │   ├── visualizations/       # 新增：可视化组件库
│   │   │   ├── charts/           # 各类图表组件
│   │   │   ├── dashboards/       # 仪表盘组件
│   │   │   └── interactive/      # 交互式数据展示
│   │   └── intelligent-agents/   # 新增：智能代理UI组件
│   │       ├── AgentChat.vue     # 代理聊天界面
│   │       ├── ToolSelector.vue  # 工具选择器
│   │       └── FunctionDisplay.vue # 函数调用展示
│   ├── views/
│   │   ├── ReportStudio.vue      # 研报工作室页面
│   │   ├── TemplateCenter.vue    # 模板中心页面
│   │   └── DataInsights.vue      # 数据洞察页面
│   ├── services/
│   │   ├── reportEngine.js       # 研报引擎服务
│   │   ├── dataProcessing.js     # 数据处理服务
│   │   ├── aiService.js          # AI服务接口
│   │   └── mcpService.js         # MCP函数调用服务
```

### 3.2 用户界面设计

- **现代化仪表盘**：采用卡片式布局，提供数据概览
- **拖拽式研报编辑器**：允许用户自由排列和组织研报内容
- **对话框**：自然语言交互窗口，支持语音和文本输入
- **模板市场**：预设研报模板库，支持一键应用
- **实时协作**：多用户同时编辑研报的能力
- **响应式设计**：适配不同设备和屏幕尺寸

## 4. 后端实现

### 4.1 核心模块

```
src/
├── api/
│   ├── routes/
│   │   ├── report_routes.py      # 研报相关API路由
│   │   ├── analysis_routes.py    # 分析相关API路由
│   │   ├── data_routes.py        # 数据管理API路由
│   │   └── mcp_routes.py         # MCP功能API路由
├── core/
│   ├── report_engine/            # 研报生成引擎
│   │   ├── templates/            # 研报模板处理
│   │   ├── renderer.py           # 研报渲染器
│   │   └── exporter.py           # 研报导出工具
│   ├── analysis/                 # 分析核心功能
│   │   ├── data_processor.py     # 数据预处理
│   │   ├── insight_generator.py  # 洞察生成器
│   │   └── visualization_engine.py # 可视化引擎
│   └── agents/                   # 智能代理系统
│       ├── mcp_agent.py          # MCP函数调用代理
│       ├── research_agent.py     # 研究代理
│       ├── visualization_agent.py # 可视化代理
│       └── report_agent.py       # 研报代理
├── services/
│   ├── llm_service.py            # LLM服务接口
│   ├── database_service.py       # 数据库服务
│   ├── cache_service.py          # 缓存服务
│   └── file_service.py           # 文件处理服务
```

### 4.2 MCP函数调用集成

MCP (Model Control Protocol) 函数调用是系统的核心特性。这些函数通常由一系列独立的、遵循 MCP 规范的服务器提供。后端系统的智能代理 (特别是 `mcp_agent.py`) 将充当 MCP 客户端，通过 MCP 协议与这些服务器通信，调用它们暴露的工具。我们将根据需要集成以下类型的 MCP 工具/函数：

1.  **数据处理与分析函数集 (可能由 `mcp-server-datasette`, `mcp-server-sqlite` 或自定义Python分析服务器提供)**
    *   `query_data(source, query_string)`：针对指定数据源（如数据库、CSV）执行查询。
    *   `get_dataset_schema(data_reference)`：获取数据集的结构信息。
    *   `calculate_descriptive_stats(data_reference, columns)`：计算指定列的描述性统计数据。
    *   `detect_anomalies(data_reference, column, method)`：检测数据中的异常值。
    *   `perform_correlation_analysis(data_reference, columns)`：计算变量间的相关性。
    *   `execute_data_transformation(data_reference, transformation_script)`：执行数据转换操作。

2.  **可视化函数集 (可能由集成 ECharts/D3.js 的自定义可视化服务器或 `@modelcontextprotocol/server-chartjs` 等提供)**
    *   `generate_chart_config(data_reference, chart_type, mapping_config)`：根据数据和图表类型生成图表配置。
    *   `render_chart_from_config(chart_config)`：根据配置渲染图表并返回图像或可嵌入代码。

3.  **文本处理与内容生成函数集 (可能由 LLM 服务自身通过函数调用，或专门的 NLP 工具服务器提供)**
    *   `summarize_text(text, length_constraint)`：总结文本内容。
    *   `extract_keywords(text, count)`：提取文本中的关键词。
    *   `generate_text_segment(prompt, style_guide, context_data)`：根据提示、风格和上下文生成文本片段。
    *   `translate_text(text, target_language)`：翻译文本。

4.  **外部数据与知识获取函数集**
    *   `web_search(query, num_results)` (例如通过 `@modelcontextprotocol/server-brave-search`): 执行网页搜索。
    *   `fetch_url_content(url)` (例如通过 `@modelcontextprotocol/server-url-reader`): 获取指定 URL 的主要内容。
    *   `get_financial_data(ticker, metrics, timeframe)` (可能通过专门的金融数据 MCP 服务器): 获取市场数据。
    *   `query_knowledge_base(query, knowledge_base_id)` (例如通过 `@modelcontextprotocol/server-aws-kb-retrieval` 或类似工具): 查询特定的知识库。
    *   `get_news_articles(keywords, sources, timeframe)` (例如通过 `@modelcontextprotocol/server-newsapi`): 搜索相关新闻。

5.  **文件与系统交互函数集**
    *   `read_file_content(file_path_or_reference)` (例如通过 `@modelcontextprotocol/server-filesystem`，需严格控制权限): 读取文件内容。
    *   `list_directory_contents(directory_path_or_reference)` (同上): 列出目录内容。
    *   `get_current_datetime()`: 获取当前日期和时间。

### 4.3 MCP 服务器管理与执行

后端系统，特别是智能代理模块 (`src/core/agents/mcp_agent.py`)，将负责作为 MCP 客户端与这些外部 MCP 服务器进行交互。这包括：

1.  **服务器进程管理**：
    *   **配置驱动**：系统将通过配置文件（例如 `config/mcp_servers.yaml` 或集成到 `app_config.yaml`）定义需要启动和管理的 MCP 服务器。配置内容将包括服务器名称、启动命令 (如 `npx @modelcontextprotocol/server-memory`, `python -m mcp_module`, 或指向自定义脚本)、必要的参数、环境变量以及服务器的地址和端口。
    *   **动态启动与停止**：后端系统应具备根据配置启动这些 MCP 服务器子进程的能力。在系统关闭或不再需要特定服务器时，也应能优雅地停止它们。
    *   **生命周期监控**：考虑实现对关键 MCP 服务器进程的健康检查和自动重启机制，以确保服务的可用性。

2.  **通信协议**：
    *   所有交互将遵循 Model Context Protocol 规范，确保与不同语言实现、不同来源的 MCP 服务器的互操作性。

3.  **工具注册与发现**：
    *   客户端（`mcp_agent.py`）需要知道每个 MCP 服务器提供了哪些工具。这可以通过配置静态定义，或者如果服务器支持，通过 MCP 的内省端点动态发现。

4.  **安全性**：
    *   对于需要访问敏感资源（如文件系统、数据库）的 MCP 服务器，必须实施严格的权限控制和沙箱机制。
    *   客户端与服务器之间的通信，尤其是在跨网络边界时，应考虑使用 TLS/SSL 加密。

5.  **管理工具集成 (可选)**：
    *   为了简化 MCP 服务器的部署、管理和监控，未来可以考虑集成社区提供的 MCP 管理工具或平台，例如 `mcpm (MCP Manager)`, `mcp.run`, 或 `MCPHub`。这些工具可以帮助进行服务器的安装、版本控制、配置管理和日志聚合等。初期阶段，可以从手动配置和管理启动，随着系统复杂度的增加再评估引入这些工具的必要性。

6.  **自定义服务器开发**：
    *   对于 `GlyphMinds` 特有的、无法通过现有社区服务器满足的需求（例如，一个调用内部专有风格分析模型的工具），我们将使用 MCP SDK (Python 为首选，与后端技术栈一致) 开发自定义的 MCP 服务器。这些自定义服务器也将遵循上述管理和执行原则。

## 5. 智能代理系统

### 5.1 代理类型与职责

1. **协调代理 (Coordinator)**
   - 负责理解用户意图，分解任务
   - 调度和管理其他专业代理
   - 监控整体任务进度和质量

2. **数据代理 (Data Agent)**
   - 数据清洗、预处理和转换
   - 特征提取和选择
   - 统计分析和解释

3. **可视化代理 (Visualization Agent)**
   - 自动选择最佳可视化方式
   - 优化图表参数和布局
   - 生成交互式数据展示

4. **研报代理 (Report Agent)**
   - 研报结构规划
   - 内容生成和组织
   - 语言风格调整

### 5.2 代理协作流程

```
用户查询 --> 协调代理 --> 任务分解
                        |
                        |--> 数据代理 --> 数据获取与分析 --> 结果汇总
                        |                                      |
                        |--> 可视化代理 --> 图表生成 --------->|
                        |                                      v
                        |--> 研报代理 ------------------------>| 统合结果
                                                               |
                                                               v
                                                          最终研报
```

## 6. 数据流程

### 6.1 研报生成流程

1. **数据获取与预处理**
   - 用户导入数据或指定数据源
   - 系统进行自动数据清洗和标准化
   - 生成数据概览和基础统计信息

2. **智能分析阶段**
   - LLM分析数据特征和结构
   - 识别关键指标和模式
   - 发现数据中的异常和特殊点
   - 生成初步洞察和分析方向

3. **可视化生成阶段**
   - 自动为关键发现选择适合的可视化类型
   - 生成具有信息量的图表
   - 优化图表参数以最佳展示数据特征
   - 组织图表形成可视化叙事

4. **研报撰写阶段**
   - 根据模板或用户需求创建研报结构
   - 为每个部分生成专业内容
   - 整合可视化和分析结果
   - 根据行业惯例调整语言风格和术语

5. **交互优化阶段**
   - 用户反馈和修改请求
   - 系统根据反馈调整研报内容
   - 生成最终研报文档

### 6.2 数据分析流水线

```
原始数据 --> 数据清洗 --> 特征提取 --> 统计分析 --> 模式识别 --> 洞察生成
    |          |           |           |           |           |
    v          v           v           v           v           v
元数据提取   缺失值处理   维度推断   描述统计    趋势检测    关键发现
    |          |           |           |           |           |
    |          |           |           |           |           |
    ----------------------------------------------------------
                                |
                                v
                          数据知识图谱
                                |
                                v
                          数据知识图谱
                                (可利用GraphRAG等技术构建和查询，为LLM提供更精准的上下文，应对超长文本输入和上下文过载问题)
                                |
                                v
                          研报内容生成
```

## 7. 技术栈选择

### 7.1 前端技术

- **框架**：Vue.js 3 (与现有项目保持一致)
- **UI组件库**：Element Plus
- **可视化库**：ECharts, D3.js
- **状态管理**：Pinia
- **编辑器**：ProseMirror/TipTap (富文本编辑)
- **API通信**：Axios

### 7.2 后端技术

- **框架**：FastAPI (高性能异步API)
- **LLM集成**：Langchain，Auto Gen，GraphRAG 工作流等
- **数据处理**：Pandas, NumPy, SciPy
- **数据库**：PostgreSQL (结构化数据), MongoDB (非结构化数据)
- **缓存**：Redis
- **任务队列**：Celery (处理长时间运行的任务)

### 7.3 部署与基础设施

- **容器化**：Docker
- **编排**：Kubernetes
- **CI/CD**：GitLab CI
- **监控**：Prometheus, Grafana
- **日志管理**：ELK Stack

## 8. 实现路线图

### 8.1 第一阶段：基础设施构建 (4周)

- 建立项目结构和代码框架
- 实现基本的数据导入和存储功能
- 开发简单的LLM集成接口
- 创建基础UI组件和布局

### 8.2 第二阶段：核心功能开发 (8周)

- 实现MCP函数调用系统
- 开发数据分析和可视化引擎
- 构建研报模板系统
- 创建基础代理系统框架

### 8.3 第三阶段：代理系统与高级功能 (6周)

- 完成智能代理系统
- 实现代理协作机制
- 开发高级数据分析功能
- 构建复杂可视化和交互式图表

### 8.4 第四阶段：优化与集成 (4周)

- 系统性能优化
- 用户体验改进
- 集成测试和bug修复
- 文档和示例完善

## 9. 安全与隐私考虑

- **数据加密**：所有存储和传输的数据进行加密
- **访问控制**：基于角色的细粒度权限系统
- **隐私保护**：支持数据脱敏和匿名化处理
- **审计日志**：所有操作留下可追溯的审计记录
- **合规性**：符合GDPR, CCPA等数据保护法规

## 10. 扩展与未来规划

- **多语言支持**：扩展到支持多种语言的研报生成
- **行业专精模型**：针对特定行业训练的专业分析模型
- **协作功能**：团队协作编辑和评审研报
- **移动端适配**：完整的移动端体验
- **API生态**：开放API允许第三方集成和扩展
- **插件系统**：允许用户和开发者创建自定义功能插件

## 11. 总结

智能研报系统利用最先进的LLM技术和MCP函数调用功能，创建了一个端到端的数据分析和研报生成平台。通过智能代理系统的协作，使复杂的数据分析任务变得简单易用，让非专业用户也能获得专业质量的数据洞察和研报。

该系统不仅提高了研报生成的效率，还通过AI的创造力和洞察力，提升了研报的质量和价值。这一平台有潜力彻底改变传统的数据分析和研报工作流程，为组织带来显著的时间和成本节约。 